{{ "<!-- navigation -->" | safeHTML }}
<!-- Auth0 Scripts -->
<script src="https://cdn.auth0.com/js/auth0-spa-js/1.19/auth0-spa-js.production.js"></script>
{{ partial "auth0-config.html" }}
<script src="{{ "auth0-init.js" | relURL }}"></script>

<header class="header-nav position-relative {{.Scratch.Get `bg`}}" data-aos="fade-in">
  <div class="container">
    <nav class="navbar navbar-expand-xl navbar-light px-0">
      <a class="navbar-brand p-0" href="{{ site.BaseURL | relLangURL }}/">
        {{ partial "logo.html" }}
      </a>

      <button class="navbar-toggler bg-white rounded-0 p-0" type="button" data-bs-toggle="collapse"
        data-bs-target="#navlinks" aria-controls="navlinks" aria-expanded="false" aria-label="Toggle navigation">
        <svg class="nav-toggle-icon" viewBox="0 0 100 100" width="40" onclick="this.classList.toggle('active')">
          <path class="line top"
            d="m 70,33 h -40 c 0,0 -8.5,-0.149796 -8.5,8.5 0,8.649796 8.5,8.5 8.5,8.5 h 20 v -20" />
          <path class="line middle" d="m 70,50 h -40" />
          <path class="line bottom"
            d="m 30,67 h 40 c 0,0 8.5,0.149796 8.5,-8.5 0,-8.649796 -8.5,-8.5 -8.5,-8.5 h -20 v 20" />
        </svg>
      </button>

      <div class="collapse navbar-collapse" id="navlinks">
        <ul class="navbar-nav mx-auto">
          {{ range site.Menus.main }}
          {{ if .HasChildren }}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex justify-content-between align-items-center" href="#"
              id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <span class="me-1">{{ .Name }}</span>
              <svg width="9" height="6" viewBox="0 0 9 6" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M9 1.06L7.94 0L4.5 3.44L1.06 0L0 1.06L4.5 5.56L9 1.06Z" fill="currentColor" />
              </svg>
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
              {{ range .Children }}
              <li><a class="dropdown-item" {{if findRE `^http` .URL}}target="_blank" {{end}}
                  href="{{if findRE `^#` .URL}}{{if not $.IsHome}}{{site.BaseURL | relLangURL}}{{end}}{{ .URL }}{{else}}{{.URL | relLangURL}}{{end}}">{{
                  .Name }}</a>
              </li>
              {{ end }}
            </ul>
          </li>
          {{ else }}
          <li class="nav-item">
            <a class="nav-link" {{if findRE `^http` .URL}}target="_blank" {{end}}
              href="{{if findRE `^#` .URL}}{{if not $.IsHome}}{{site.BaseURL | relLangURL}}{{end}}{{ .URL }}{{else}}{{.URL | relLangURL}}{{end}}">{{
              .Name }}</a>
          </li>
          {{ end }}
          {{ end }}
          
          <!-- Language selector -->
          {{ if .IsTranslated }}
          <li class="nav-link">
            <select class="border-0 bg-transparent" id="select-language" onchange="location = this.value;">
              {{ $siteLanguages := site.Languages}}
              {{ $pageLang := .Page.Lang}}
              {{ range .Page.AllTranslations }}
              {{ $translation := .}}
              {{ range $siteLanguages }}
              {{ if eq $translation.Lang .Lang }}
              {{ if eq $pageLang .Lang}}
              <option id="{{ $translation.Language }}" value="{{ $translation.Permalink }}" selected>{{ .LanguageName }}</option>
              {{ else }}
              <option id="{{ $translation.Language }}" value="{{ $translation.Permalink }}">{{ .LanguageName }}</option>
              {{ end }}
              {{ end }}
              {{ end }}
              {{ end }}
            </select>
          </li>
          {{ end }}
        </ul>
      
        <!-- Auth Section -->
        <div class="d-flex align-items-center">
          <!-- Loading indicator -->
          <div id="auth-loading" class="spinner-border spinner-border-sm me-2" style="display: none;" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          
          <!-- Login/Signup buttons (shown when not authenticated) -->
          <div id="auth-buttons" style="display: none;">
            {{ with site.Params.navigation_button_bordered}}
            {{ if .enable }}
            <button id="signup-btn" class="btn btn-sm btn-outline-primary me-2">{{ .label }}</button>
            {{ end }}
            {{ end }}

            {{ with site.Params.navigation_button_linked}}
            {{ if .enable }}
            <button id="login-btn" class="btn btn-sm btn-link pe-xl-0">{{ .label }}
              <svg width="1.5em" height="1.5em" viewBox="0 0 16 16" fill="currentColor">
                <path fill-rule="evenodd" d="M4 8a.5.5 0 0 1 .5-.5h5.793L8.146 5.354a.5.5 0 1 1 .708-.708l3 3a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708-.708L10.293 8.5H4.5A.5.5 0 0 1 4 8z"/>
              </svg>
            </button>
            {{ end }}
            {{ end }}
          </div>

          <!-- User menu (shown when authenticated) -->
          <div id="user-menu" class="dropdown" style="display: none;">
            <button id="user-dropdown-btn" class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <span id="user-name">User</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="/profile/">Profile</a></li>
              <li><a class="dropdown-item" href="/faq/">FAQ</a></li>
              <li><a class="dropdown-item" href="/services/">Services</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><button id="logout-btn" class="dropdown-item" type="button">Log out</button></li>
            </ul>
          </div>
        </div>
      </div>
    </nav>
  </div>
</header>

<!-- Initialize auth after DOM loads -->
<script>
// Consolidated auth management - no separate files needed
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üîß Initializing header auth...');
    
    const elements = {
        authLoading: document.getElementById('auth-loading'),
        authButtons: document.getElementById('auth-buttons'),
        userMenu: document.getElementById('user-menu'),
        userName: document.getElementById('user-name'),
        loginBtn: document.getElementById('login-btn'),
        signupBtn: document.getElementById('signup-btn'),
        logoutBtn: document.getElementById('logout-btn')
    };
    
    let currentUser = null;
    
    function showLoading() {
        if (elements.authLoading) elements.authLoading.style.display = 'block';
        if (elements.authButtons) elements.authButtons.style.display = 'none';
        if (elements.userMenu) elements.userMenu.style.display = 'none';
    }
    
    function hideLoading() {
        if (elements.authLoading) elements.authLoading.style.display = 'none';
    }
    
    function updateUIForUser(user) {
        console.log('üë§ User authenticated:', user?.email);
        currentUser = user;
        hideLoading();
        
        if (elements.authButtons) elements.authButtons.style.display = 'none';
        if (elements.userMenu) elements.userMenu.style.display = 'block';
        if (elements.userName && user) {
            elements.userName.textContent = user.name || user.email || 'User';
        }
    }
    
    function updateUIForGuest() {
        console.log('üë§ User not authenticated');
        currentUser = null;
        hideLoading();
        
        if (elements.userMenu) elements.userMenu.style.display = 'none';
        if (elements.authButtons) elements.authButtons.style.display = 'flex';
    }
    
    // Show loading initially
    showLoading();
    
    try {
        const auth0Client = await window.auth0ClientPromise;
        console.log('‚úÖ Auth0 client ready');
        
        // Check initial auth status
        const isAuthenticated = await auth0Client.isAuthenticated();
        if (isAuthenticated) {
            const user = await auth0Client.getUser();
            updateUIForUser(user);
        } else {
            updateUIForGuest();
        }
        
        // Set up event listeners
        if (elements.loginBtn) {
            elements.loginBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                sessionStorage.setItem('auth0_return_to', '/profile/');
                await auth0Client.loginWithRedirect({
                    authorizationParams: {
                        redirect_uri: window.location.origin + '/callback/'
                    }
                });
            });
        }
        
        if (elements.signupBtn) {
            elements.signupBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                sessionStorage.setItem('auth0_return_to', '/profile/');
                await auth0Client.loginWithRedirect({
                    authorizationParams: {
                        redirect_uri: window.location.origin + '/callback/',
                        screen_hint: 'signup'
                    }
                });
            });
        }
        
        if (elements.logoutBtn) {
            elements.logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                await auth0Client.logout({
                    logoutParams: { returnTo: window.location.origin }
                });
            });
        }
        
        // Listen for auth state changes from callback
        window.addEventListener('authStateChanged', (event) => {
            if (event.detail.isAuthenticated && event.detail.user) {
                updateUIForUser(event.detail.user);
            } else {
                updateUIForGuest();
            }
        });
        
        console.log('‚úÖ Header auth initialized');
        
    } catch (error) {
        console.error('‚ùå Header auth initialization failed:', error);
        updateUIForGuest();
    }
});
</script>
{{ "<!-- /navigation -->" | safeHTML }}
